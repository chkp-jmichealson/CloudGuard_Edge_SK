<h2>Overview</h2>
<p>This article describes how cloud-init automation within the CloudGuard Edge image can be
  leveraged to bootstrap a virtual machine built to run on the KVM hypervisor by various platforms. The bootstrap
  process
  includes multiple methods of user-data input as well as user-data formats. As of this writing, these <em>Generic</em>
  and <em>OpenStack</em> images
  are provided by the Check Point Cloud Alliance or Telco teams at customer request. The automation descibed within will
  be added to Generally Available images in the future.</p>
<br>
<h2>Metadata Input Methods</h2>
<h3>Config Drive</h3>
<p>The most common method of providing metadata is a config drive. A config drive is a predefined file structure of VM
  configuration information that is contained in a specially labeled ISO and then attached at VM creation time. Upon
  first boot, the OS starts a bootstrapping service that searches for this mounted ISO via a <strong>blkid
    label</strong>
  and\or <strong>filesystem type</strong> and then reads the metadata from the file structure. It is possible to input
  basic VM meta information or complex multi-part scripts, service provider logos and more via this method.
  <br /><br />While Check Point references the standards of cloud-init, some variations may exist. The Check Point image
  with this updated bootstrapping has a naming convention that distinguishes the image automation within the image
  <em>Generic</em> and <em>OpenStack</em>.</p>
<br>
<h3>HTTP metadata service</h3>
<p>Virtual machine information may be polled from an HTTP metadata service within OpenStack KVM platform providers.
  Be aware that not all OpenStack or KVM operators enable this service. The data available via the HTTP meta-service is
  the same as what is provided via config drive (vendor, network, meta, and user data). The CG IaaS bootstrap service
  shows
  preference to a mounted config drive at first boot; when an attached config drive is not detected, the bootstrap
  service will attempt to poll the http service for the configuration data. One benefit of HTTP metadata vs. config
  drive is
  that it is dynamic, presenting network interface changes to the VM post deployment. Conversely, config drive
  data is only populated by the platform at VM instantiation.<br>
  The this section is provided for <em>information purposes only.</em> The CG Edge bootstrap service <strong>does
    not</strong> consume HTTP metadata
  service data. </p><br>

<h3>Check Point OpenStack Labeled QCOW Image Requirements</h3>
<ol type="1">
  <li>ISO label is set as "config-2"</li>
  <li>The file structure for an OpenStack deployment has the following requirements:</li>
  <ol type="i">
    <li>The configuration files (vendor, network, meta, and user data) must be placed in the ISO
      <em>/openstack/latest/</em> directory by the platform.</li>
    <li>vendor_data.json</li>
    <ol type="a">
      <li>Check Point does not utilize this file.</li>
    </ol>
    <li>network_data.json</li>
    <ol type="a">
      <li>May specify DHCP or static interface configurations per interface.</li>
      <li>If configured as DHCP, the bootstrapping automation polls for a DHCP provided address on specified interfaces,
        consumes that DHCP address, and statically assigns it to the interface.</li>
    </ol>
    <li>meta_data.json</li>
    <ol type="a">
      <li>SSH Key</li>
      <li>Virtual machine name is provided by the platform. This VM name is consumed as the OS hostname unless a
        hostname is specified in user_data.</li>
    </ol>
    <li>user_data</li>
    <ol type="a">
      <li>16k file limit</li>
      <li>Description of additional data provided in <a href="#user_data">user_data</a> section.</li>
    </ol>
  </ol>
</ol>
<br>

<h3>Check Point Generic Labeled QCOW Image Requirements</h3>
<ol type="1">
  <li>ISO must be type &ldquo;ISO9660&rdquo;</li>
  <li>The ISO file structure has the following requirements:</li>
  <ol type="i">
    <li>The <strong>user_data</strong> file can be placed anywhere within the ISO (Check Point recommends the root
      directory).</li>
    <li>16k file limit</li>
    <li>Description of additional data provided in the <a href="#user_data">user_data</a> section.</li>
  </ol>
</ol>
<br>

<h3>CloudGuard Edge VNF Interface Requirements</h3>
<p>
  <ol type="1">
    <li>CG Edge VNF images reqire a minimum of <strong>three</strong> interfaces:</li>
    <ol type="i">
      <li>Virtual machine eth0 maps to WAN interface.</li>
      <li>Virtual machine eth1 maps to DMZ interface.</li>
      <li>Virtual machine eth2 maps to LAN1 interface.</li>
      <li>Virtual machine eth3 maps to LAN2 interface.</li>
      <li>Series continues...</li>
    </ol>
    <li>OpenStack images rely on interface configuration to be provided by the platform. When not
      provided this information the defaults are:</li>
    <ol type="i">
      <li>WAN - the bootstrapping service will attempt to configure the interface with a static IP obtained via DHCP.
      </li>
      <li>DMZ - interface will be unconfigured.</li>
      <li>LAN1 - the bootstrapping service will configure with a static IP address of 192.168.1.1/24.</li>
      <li>LAN2, etc - unconfigured. </li>
    </ol>
    <li>Generic images rely on interface configuration to be provided in the user_data file. When not
      providing this information the defaults are:</li>
    <ol type="i">
      <li>WAN - the bootstrapping service will attempt to configure the interface with a static IP obtained via DHCP.
      </li>
      <li>DMZ - interface will be unconfigured.</li>
      <li>LAN1 - the bootstrapping service will configure with a static IP address of 192.168.1.1/24.</li>
      <li>LAN2, etc - unconfigured. </li>
    </ol>
  </ol>
</p>
<br>



<h3 id="user_data">Check Point user_data Customization Formats</h3>
<p>This information in this section applies to both <em>Generic</em> and <em>OpenStack</em> images.</p>
<ol type="1">
<li>User_data may be provided via HTTP metadata service or config drive; not all operators enable platform HTTP
  metadata services.</li>
<li>Config Drive ISO file structure has the following options:</li>
<ol type="i">
  <li>The Check Point bootstrapping service will parse user_data and determine the format of the scripts to parse
    automatically.</li>
  <li>user_data has no format requirement besides properly following the convention of the chosen file format.</li>
  <li>The order of operation for the Check Point bootstrapping service is MIME, cloud-config, and bash.</li>
  <li>In the event that MIME or cloud-config are not detected, the user_data is processed as a bash script.</li>
  <li>The user_data file may be presented as cloud-config in a <a href="#yaml">yaml</a> format.</li>
  <li>user_data may be presented as <a href="#bash">bash</a> format.</li>
  <li>user_data may be presented as multi-part mime format.</li>
  <li>This method supports text/cloud-config and text/x-shellscript.</li>
  <ol type="a">
    <li>An example of when to use multi-part mime is <a
        href="https://www.terraform.io/docs/providers/template/d/cloudinit_config.html" target="_blank"
        rel="noopener">terraform templates.</a></li>
    <li>For complex configurations using a mixture of cloud-config and bash it is suggested to utilize multi-part
      mime.</li>
  </ol>
</ol>
</ol>
<br>

<h2>Examples</h2>
<h3 id="yaml">Cloud-config user_data gateway yaml</h3>
<p>The generic CG Edge image has no settings for a cloud-config gateway deployment. However, <em>not providing any user data </em> will result in a VNF with a default configutaion and require the first-time-wizard to be ran manually.</p>
<p>
  <blockquote>
    <pre>
    <code>
  ###Example file. Removing a stanza will result in system defaults for that section.<br />
  #cloud-config

  ssh_authorized_keys:
  - ssh-rsa AA/yxVV1zfVGaJD801Xt6EiQ2LWPEwVc3e5GsCkCgWyBb6HLkMyR0VLZzM7QLrXJgcC/ dev@dev
    
  system:
  &nbsp;hostname: CloudGuardEdge
  &nbsp;domainname: labnet.com
  &nbsp;management_mode: central
  &nbsp;central_managent:
  &nbsp;&nbsp;address: 10.200.1.3
  &nbsp;&nbsp;gateway_sic_key: vpn123
  ### DNS set in system area is redundant when implemented on WAN interface.
  &nbsp;dns1: 1.1.1.1
  &nbsp;dns2: 8.8.8.8
  &nbsp;dns3: 4.2.2.2
  &nbsp;ntp1:
  &nbsp;&nbsp;address: ntp.checkpoint.com
  &nbsp;ntp2:
  &nbsp;&nbsp;address: ntp2.checkpoint.com
    
  cpusers:
  &nbsp;- name: admin
  &nbsp;&nbsp;shell: /bin/bash
  &nbsp;&nbsp;password-hash: $1$Gz8EHpk6$L7YYYtIN6zThsBp0n6cAI0
  &nbsp;- name: joe
  &nbsp;&nbsp;shell: /etc/cli.sh
  &nbsp;&nbsp;password-hash: $1$Gz8EHpk6$L7YYYtIN6zThsBp0n6cAI0
  &nbsp;&nbsp;permission: read-write

  ### Static WAN/Management interface example
  interfaces:
  - name: WAN
  &nbsp;ipv4-address: 10.87.0.105
  &nbsp;subnet-mask: 255.255.255.0
  &nbsp;dns1: 10.56.0.1
  &nbsp;dns2: 8.8.8.8
  &nbsp;default-gw: 10.87.0.200
  &nbsp;mgmt: true
  - name: br0
  &nbsp;ipv4-address: 172.34.150.100
  &nbsp;subnet-mask: 255.255.255.248
  - name: DMZ
  &nbsp;bridge: br0
  - name: LAN1
  &nbsp;bridge: br0

  # DHCP WAN/Management interface example
  interfaces:
  - name: WAN
  &nbsp;mgmt: true
  &nbsp;ipv4-address: dhcp
  - name: br0
  &nbsp;ipv4-address: 172.34.150.100
  &nbsp;subnet-mask: 255.255.255.248
  - name: DMZ
  &nbsp;bridge: br0
  - name: LAN1
  &nbsp;bridge: br0

  vpn:
  sites:
  &nbsp;&nbsp;- peer_name: VPNPeer1
  &nbsp;&nbsp;&nbsp;peer_address: 1.2.3.4
  &nbsp;&nbsp;&nbsp;peer_encryption_domain_network: 192.168.70.0
  &nbsp;&nbsp;&nbsp;peer_encryption_domain_subnet: 255.255.255.0
  &nbsp;&nbsp;&nbsp;peer_shared_secret: supersecretkey1
  &nbsp;&nbsp;- peer_name: VPNPeer2
  &nbsp;&nbsp;&nbsp;peer_address: 4.5.6.7
  &nbsp;&nbsp;&nbsp;peer_encryption_domain_network: 192.168.80.0
  &nbsp;&nbsp;&nbsp;peer_encryption_domain_subnet: 255.255.255.0
  &nbsp;&nbsp;&nbsp;peer_shared_secret: supersecretkey2

  cpusers:
  - name: admin
  &nbsp;shell: /bin/bash
  &nbsp;password-hash: $1$t00e9wFc$R/8X5130WvmJbgdhj7D/T/
  - name: john
  &nbsp;shell: /etc/cli.sh
  &nbsp;password-hash: $1$t00e9wFc$R/8X5130WvmJbgdhj7D/T/
  &nbsp;permission: read-write

  clishcmd:
  - set message banner msgvalue "Welcome to Check Point CloudGuard Edge" on
  - set ui-settings use-custom-webui-logo true
  - set ui-settings custom-webui-logo-url https://www.customer.com/
  write_files:
  &nbsp;- path: /opt/fw1/conf/custom_ui_logo.png
  &nbsp;&nbsp;permissions: '0664'
  &nbsp;&nbsp;owner: admin:root
  &nbsp;&nbsp;encoding: b64
  &nbsp;&nbsp;content: |
          AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEB
          5peaMhIa91kjG_THIS_IS_A_BASE_64_ENCRYPTED_JPG_Zm3I7ihjxrlw0pLNDneVDlrVc0pNFW
          hxtDiqSmnDXRV_THIS_IS_JUST_AN_EXAMPLE_NOT_REQUIRED_sS+Mus+8s+7P8ivNyL+FY/l5P
  &nbsp;&nbsp;&nbsp;&nbsp;+YrxlNn4ir7yr/NGYYf7Uv8Asf0eHxkzvYj+bHnzwIZF/fGh/wA26/6WJ4ylyf6X+lvm7GDH1g/w
  &nbsp;&nbsp;&nbsp;&nbsp;K4D/ACq4f9GuHjMvP//Z+bHnzwIZF/fGh/wA26/6WJ4ylyf6X+lvm7GDH1g/wfGh/w8Asf0eHxkz
          </code>
          </pre>
  </blockquote>
</p>


<br>
<h4 id="bash">Bash CG Edge Gateway user_data</h4>
<p>
  <blockquote>
    <pre>
      <code>
# Management interface 

add internet-connection interface WAN type static ipv4-address 10.100.0.5 subnet-mask 255.255.255.0 default-gw 10.100.0.1 conn-test-timeout 0 name Mgmt 
OR  
add internet-connection interface WAN type dhcp name Mgmt conn-test-timeout 0 
THEN 
set internet-connection Mgmt disable-nat on 
set internet-connection Mgmt route-traffic-through-default-gateway false 

# Internet Interfaces 

add internet-connection interface LAN4 type dhcp name Internet1 conn-test-timeout 0 
add internet-connection interface LAN5 type dhcp name Internet2 conn-test-timeout 0 
OR 
add internet-connection interface LAN4 type static ipv4-address 10.100.0.7 subnet-mask 255.255.255.0 default-gw 10.100.0.1 conn-test-timeout 0 name Internet1  
add internet-connection interface LAN5 type static ipv4-address 10.100.0.8 subnet-mask 255.255.255.0 default-gw 10.100.0.1 conn-test-timeout 0 name Internet2 

# Globals 
set property first-time-wizard off 
set admin-access interfaces WAN access allow 
set admin-access allowed-ipv4-addresses any 
set security-management mode locally-managed 
set antispoofing advanced-settings global-activation "false" 
set dhcp server interface WAN disable 
set dhcp server interface DMZ disable 
set dhcp server interface LAN1 disable 
set dhcp server interface LAN2 disable 
set dhcp server interface LAN3 disable 
set dhcp server interface LAN4 disable 
set dhcp server interface LAN5 disable 

# DMZ Interface 

add interface DMZ vlan 100 
add interface DMZ vlan 101 
add interface DMZ vlan 150 
add interface DMZ vlan 151 
set interface DMZ:100 ipv4-address 192.168.100.254 mask-length 24 
set interface DMZ:101 ipv4-address 192.168.101.254 mask-length 24 
add bridge name bro 
set dhcp server interface br0 disable 
set interface br0 ipv4-address 172.34.150.100 mask-length 24 
set bridge br0 add member DMZ:150 
set bridge br0 add member DMZ:151 

# LAN1 Interface as trunk

add interface LAN1 vlan 200 
add interface LAN1 vlan 201 
add interface LAN1 vlan 250 
add interface LAN1 vlan 251 
set interface LAN1:200 ipv4-address 192.168.200.254 mask-length 24 
set interface LAN1:201 ipv4-address 192.168.201.254 mask-length 24 
add bridge name br1 
set dhcp server interface br1 disable 
set interface br1 ipv4-address 172.34.250.100 mask-length 24 
set bridge br1 add member LAN1:250 
set bridge br1 add member LAN1:251
</code>
</pre>
  </blockquote>
</p>

<p><br>
  <h3 id="iso">ISO Creation</h3>
  <p>There are various tools to create an ISO, genisofs, mkisofs and xorriso are the most common.</p>
  <p>
    <ul>
      <li>bash_prompt:&gt; genisoimage -output /tmp/myUserData-gw.iso -volid config-2 -joliet -r
        ~/cloud-init/myUserData/openstack.gw/
      <li>bash_prompt:&gt; mkisofs -r -V config-2 -o /tmp/myUserData-gw.iso /tmp/cloud-init/myUserData/openstack.gw/
      </li>
      <li>bash_prompt:&gt; xorriso -as mkisofs -o /tmp/myUserData-gw.iso /tmp/cloud-init/myUserData/openstack.gw/</li>
    </ul>
  </p>
  <br>
</p>

<H1>Below this line be tigers</H1>

<p>While <a
    href="https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&amp;solutionid=sk120193"
    target="_blank" rel="noopener">sk120193</a> describes blink operations in detail, the blink function within the
  Generic and OpenStack image only accept the <strong>following example.</strong></p>
<p>
  <blockquote>
    <pre>
        <code>
      #!/bin/bash
      adminHash='$1$Gz8EHpk6$L7YYYtIN6zThsBp0n6cAI0'
      sicKey="vpn123"
      allowUpload="true"
      allowDownload="true"
      clusterMember="false"
      #
      echo "begin blink" &gt;&gt; /var/log/run-cloud-user-data 
      blink_config -s
      "gateway_cluster_member=${clusterMember}&amp;ftw_sic_key=${sicKey}&amp;upload_info=${allowUpload}&amp;download_info=${allowDownload}"
      echo "end blink" &gt;&gt; /var/log/run-cloud-user-data 
      #
    </code>
    </pre>
  </blockquote>
</p>
<p>Adding simple clish commands to this same user_data example enables more complex configurations:</p>
<p>
  <blockquote>
    <pre>
        <code>
    #!/bin/bash
    adminHash='$1$Gz8EHpk6$L7YYYtIN6zThsBp0n6cAI0'
    sicKey="vpn123"
    allowUpload="true"
    allowDownload="true"
    clusterMember="false"
    #
    echo "begin blink" &gt;&gt; /var/log/run-cloud-user-data 
    blink_config -s
    "gateway_cluster_member=${clusterMember}&amp;ftw_sic_key=${sicKey}&amp;upload_info=${allowUpload}&amp;download_info=${allowDownload}"
    echo "end blink" &gt;&gt; /var/log/run-cloud-user-data 
    #
    clish -c "lock database override"
    #clish -c "set user admin shell /bin/bash" -s
    clish -c "set user admin password-hash ${adminHash}" -s
    clish -c "set interface eth0 ipv4-address 120.120.120.113 mask-length 24" -s
    clish -c "set interface eth0 state on" -s
    clish -c "set static-route default nexthop gateway address 120.120.120.29 priority 1 on" -s
    clish -c "set hostname CP_Hostname" -s
    echo "end config" &gt;&gt; /var/log/run-cloud-user-data 
    </code>
      </pre>
  </blockquote>
</p>